import React, { useState, useRef, useEffect } from 'react';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';
import { useNavigate } from 'react-router-dom';
import { ownerApi, imageApi } from '../api'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º imageApi

delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

const MapEditor = ({ 
  mode, 
  hallMap, 
  stands, 
  exhibitionId, 
  onUploadHallMap, 
  onCreateStand, 
  onBookStand,
  onMapImageUpload // –ù–æ–≤—ã–π –ø—Ä–æ–ø—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
}) => {
  const mapRef = useRef(null);
  const mapInstance = useRef(null);
  const imageOverlayRef = useRef(null);
  const isDrawingRef = useRef(false);
  const navigate = useNavigate();
  const [selectedStand, setSelectedStand] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [mapImage, setMapImage] = useState(null);
  const [tempStands, setTempStands] = useState([]);
  const [showStandForm, setShowStandForm] = useState(false);
  const [standFormData, setStandFormData] = useState({
    standNumber: '',
    type: 'WALL',
    width: 100,
    height: 100
  });
  const [pendingStandPosition, setPendingStandPosition] = useState(null);
  const [imageError, setImageError] = useState(false);
  const [loading, setLoading] = useState(false);
  const [mapScale, setMapScale] = useState(1);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [uploadedImageUrl, setUploadedImageUrl] = useState(null);
  const [hallMapId, setHallMapId] = useState(hallMap?.id || null);

  // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ ==========
  useEffect(() => {
    if (!mapRef.current) return;

    if (mapInstance.current) {
      mapInstance.current.remove();
      mapInstance.current = null;
    }

    mapInstance.current = L.map(mapRef.current, {
      crs: L.CRS.Simple,
      minZoom: -3,
      maxZoom: 5,
      zoomControl: true,
      attributionControl: false,
      zoomSnap: 0.1,
      zoomDelta: 0.1,
      center: [0, 0],
      zoom: 0,
      dragging: true,
      doubleClickZoom: true,
      scrollWheelZoom: true
    });

    const defaultBounds = [[-500, -500], [500, 500]];
    mapInstance.current.setMaxBounds(defaultBounds);
    
    L.control.zoom({ position: 'topright' }).addTo(mapInstance.current);
    mapInstance.current.setView([0, 0], 0);
    mapInstance.current.on('click', handleMapClick);
    mapInstance.current.on('zoom', () => {
      if (mapInstance.current) {
        setMapScale(mapInstance.current.getZoom());
      }
    });

    return () => {
      if (mapInstance.current) {
        mapInstance.current.off('click', handleMapClick);
        mapInstance.current.off('zoom');
        mapInstance.current.remove();
        mapInstance.current = null;
      }
    };
  }, [mode]);

  useEffect(() => {
    isDrawingRef.current = isDrawing;
  }, [isDrawing]);

  useEffect(() => {
    if (!mapInstance.current || mode !== 'owner') return;

    if (isDrawing) {
      mapInstance.current.dragging.disable();
      mapRef.current.style.cursor = 'crosshair';
    } else {
      mapInstance.current.dragging.enable();
      mapRef.current.style.cursor = 'grab';
    }
  }, [isDrawing, mode]);

  useEffect(() => {
    if (hallMap?.mapImageUrl) {
      loadHallMapImage(hallMap.mapImageUrl);
      setHallMapId(hallMap.id);
    }
  }, [hallMap]);

  useEffect(() => {
    renderStands();
  }, [stands, tempStands]);

  // ========== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ù–ê –°–ï–†–í–ï–† ==========
  const handleImageUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    if (!file.type.includes('image')) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É!');
      return;
    }
    
    try {
      setLoading(true);
      setUploadProgress(10);
      
      let uploadedUrl = null;
      let mapId = hallMapId;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 10MB.');
        setLoading(false);
        return;
      }
      
      if (hallMapId) {
        // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–µ–µ
        setUploadProgress(30);
        const result = await ownerApi.uploadHallMapImage(hallMapId, file);
        uploadedUrl = result.mapImageUrl;
        setUploadProgress(70);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º hallMap —Å –Ω–æ–≤—ã–º URL
        if (onMapImageUpload) {
          await onMapImageUpload(hallMapId, uploadedUrl);
        }
      } else {
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        setUploadProgress(30);
        const mapData = {
          name: `–ü–ª–∞–Ω –∑–∞–ª–∞ ${new Date().toLocaleDateString()}`,
          exhibitionEventId: exhibitionId,
          mapImage: file
        };
        
        const result = await ownerApi.createHallMapWithImage(mapData);
        uploadedUrl = result.mapImageUrl;
        mapId = result.id;
        setHallMapId(result.id);
        setUploadProgress(70);
        
        if (onUploadHallMap) {
          await onUploadHallMap(result);
        }
      }
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (uploadedUrl) {
        setUploadedImageUrl(uploadedUrl);
        await loadImageToMap(uploadedUrl);
        setUploadProgress(100);
        
        setTimeout(() => {
          setUploadProgress(0);
          alert('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä!');
        }, 500);
      }
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.response?.data?.error || error.message}`);
      setImageError(true);
    } finally {
      setLoading(false);
      e.target.value = '';
    }
  };

  // ========== –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –í –ö–ê–†–¢–£ ==========
  const loadHallMapImage = (imageUrl) => {
    if (!mapInstance.current || !imageUrl) return;
    
    const img = new Image();
    img.crossOrigin = 'anonymous';
    
    img.onload = function() {
      const width = this.width;
      const height = this.height;
      const bounds = [[0, 0], [height, width]];
      
      // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–ª–æ–∏
      mapInstance.current.eachLayer((layer) => {
        if (!(layer instanceof L.Control)) {
          mapInstance.current.removeLayer(layer);
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      imageOverlayRef.current = L.imageOverlay(imageUrl, bounds, {
        interactive: false,
        className: 'hall-map-image'
      }).addTo(mapInstance.current);
      
      mapInstance.current.fitBounds(bounds);
      const centerY = height / 2;
      const centerX = width / 2;
      mapInstance.current.setView([centerY, centerX], 0);
      
      setImageError(false);
      setMapImage(imageUrl);
      
      setTimeout(() => {
        renderStands();
      }, 100);
    };
    
    img.onerror = function() {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      setImageError(true);
      showPlaceholder();
    };
    
    img.src = imageUrl;
  };

  const loadImageToMap = (imageUrl) => {
    return new Promise((resolve, reject) => {
      if (!mapInstance.current || !imageUrl) {
        reject('–ù–µ—Ç –∫–∞—Ä—Ç—ã –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        return;
      }

      const img = new Image();
      img.crossOrigin = 'anonymous';
      
      img.onload = function() {
        const width = this.width;
        const height = this.height;
        const bounds = [[0, 0], [height, width]];
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        if (imageOverlayRef.current) {
          mapInstance.current.removeLayer(imageOverlayRef.current);
          imageOverlayRef.current = null;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        imageOverlayRef.current = L.imageOverlay(imageUrl, bounds, {
          interactive: false,
          className: 'hall-map-image'
        }).addTo(mapInstance.current);
        
        mapInstance.current.fitBounds(bounds);
        const centerY = height / 2;
        const centerX = width / 2;
        mapInstance.current.setView([centerY, centerX], 0);
        
        setImageError(false);
        setMapImage(imageUrl);
        resolve();
      };
      
      img.onerror = function() {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
        setImageError(true);
        reject('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
      };
      
      img.src = imageUrl;
    });
  };

  const showPlaceholder = () => {
    if (!mapInstance.current) return;
    
    const bounds = [[0, 0], [500, 500]];
    
    L.rectangle(bounds, {
      color: '#e9ecef',
      fillColor: '#e9ecef',
      fillOpacity: 0.8,
      interactive: false
    }).addTo(mapInstance.current);
    
    L.marker([250, 250], {
      icon: L.divIcon({
        html: `
          <div style="
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 200px;
          ">
            <div style="font-size: 48px; color: #6c757d; margin-bottom: 10px;">üì∑</div>
            <h4 style="margin: 0 0 10px 0; color: #495057;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω –∑–∞–ª–∞</h4>
            <p style="margin: 0; color: #6c757d; font-size: 14px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
          </div>
        `,
        className: 'placeholder-text',
        iconSize: [250, 150]
      })
    }).addTo(mapInstance.current);
    
    mapInstance.current.fitBounds(bounds);
  };

  // ========== –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ==========
  const handleMapClick = (e) => {
    if (mode !== 'owner' || !isDrawingRef.current) {
      return;
    }
    
    const { lat, lng } = e.latlng;
    
    if (!imageOverlayRef.current) {
      alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω –∑–∞–ª–∞!');
      setIsDrawing(false);
      return;
    }
    
    const standPosition = { 
      lat: Math.round(lat * 100) / 100,
      lng: Math.round(lng * 100) / 100 
    };
    
    setPendingStandPosition(standPosition);
    setShowStandForm(true);
    clearTempMarkers();
    addTempMarker(standPosition);
  };

  const clearTempMarkers = () => {
    if (!mapInstance.current) return;
    
    mapInstance.current.eachLayer((layer) => {
      if (layer instanceof L.Marker && layer.options && layer.options.isTemp) {
        mapInstance.current.removeLayer(layer);
      }
    });
  };

  const addTempMarker = (position) => {
    if (!mapInstance.current) return;
    
    const tempMarker = L.marker([position.lat, position.lng], {
      icon: L.divIcon({
        html: `
          <div style="
            width: 30px;
            height: 30px;
            background: #ff0000;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(255,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
          ">
            <div style="
              width: 12px;
              height: 12px;
              background: white;
              border-radius: 50%;
            "></div>
          </div>
        `,
        className: 'temp-stand-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      }),
      zIndexOffset: 1000,
      isTemp: true,
      draggable: false
    }).addTo(mapInstance.current);
    
    tempMarker.bindPopup(`
      <div style="padding: 10px; min-width: 150px;">
        <strong>üìå –ù–æ–≤–∞—è —Ç–æ—á–∫–∞</strong>
        <div style="margin-top: 5px; font-size: 12px;">
          X: ${Math.round(position.lng)}<br>
          Y: ${Math.round(position.lat)}
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: #666;">
          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞
        </div>
      </div>
    `).openPopup();
    
    return tempMarker;
  };

  const handleToggleDrawing = () => {
    if (mode !== 'owner') {
      alert('–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º –≤—ã—Å—Ç–∞–≤–∫–∏');
      return;
    }
    
    if (!imageOverlayRef.current && !isDrawing) {
      alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω –∑–∞–ª–∞!');
      return;
    }
    
    const newState = !isDrawing;
    setIsDrawing(newState);
    
    if (!newState) {
      clearTempMarkers();
    }
  };

  const createStandMarker = (stand) => {
    if (!mapInstance.current) return;
    
    let color = '#28a745';
    if (stand.status === 'BOOKED') color = '#dc3545';
    if (stand.status === 'MAINTENANCE') color = '#ffc107';
    
    const marker = L.marker([stand.positionY, stand.positionX], {
      icon: L.divIcon({
        html: `
          <div style="
            width: 40px;
            height: 40px;
            background: ${color};
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s;
          ">
            ${stand.standNumber}
          </div>
        `,
        className: 'stand-marker-container',
        iconSize: [46, 46]
      })
    }).addTo(mapInstance.current);
    
    const popupContent = `
      <div style="padding: 15px; min-width: 250px;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <div style="width: 20px; height: 20px; background: ${color}; border-radius: 50%; margin-right: 10px;"></div>
          <h4 style="margin: 0;">–°—Ç–µ–Ω–¥ ${stand.standNumber}</h4>
        </div>
        <div style="margin-bottom: 15px;">
          <p style="margin: 5px 0;"><strong>–¢–∏–ø:</strong> ${getTypeText(stand.type)}</p>
          <p style="margin: 5px 0;"><strong>–†–∞–∑–º–µ—Ä:</strong> ${stand.width}√ó${stand.height} —Å–º</p>
          <p style="margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> 
            <span style="color: ${color}; font-weight: bold;">
              ${stand.status === 'BOOKED' ? '–ó–∞–Ω—è—Ç' : stand.status === 'MAINTENANCE' ? '–í —Ä–µ–º–æ–Ω—Ç–µ' : '–°–≤–æ–±–æ–¥–µ–Ω'}
            </span>
          </p>
          <p style="margin: 5px 0;"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> X:${stand.positionX}, Y:${stand.positionY}</p>
        </div>
        ${mode === 'artist' && stand.status === 'AVAILABLE' ? 
          `<button 
            onclick="window.handleBookStandClick('${stand.id}')" 
            style="
              width: 100%; 
              padding: 10px; 
              background: linear-gradient(135deg, #007bff, #0056b3); 
              color: white; 
              border: none; 
              border-radius: 6px; 
              cursor: pointer;
              font-weight: bold;
              transition: all 0.2s;
            "
          >
            üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
          </button>` : 
          ''
        }
      </div>
    `;
    
    window.handleBookStandClick = async (standId) => {
      try {
        await onBookStand(standId);
        alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        marker.closePopup();
        renderStands();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    };
    
    marker.bindPopup(popupContent);
    
    marker.on('click', (e) => {
      e.originalEvent.stopPropagation();
      setSelectedStand(stand);
      
      if (mode === 'artist' && stand.status === 'AVAILABLE') {
        marker.openPopup();
      }
    });
    
    marker.standData = stand;
    return marker;
  };

  const renderStands = () => {
    if (!mapInstance.current) return;
    
    mapInstance.current.eachLayer((layer) => {
      if (layer instanceof L.Marker && layer.standData) {
        mapInstance.current.removeLayer(layer);
      }
    });
    
    const allStands = [...(stands || []), ...tempStands];
    allStands.forEach(createStandMarker);
  };

  const handleSaveStand = async () => {
    if (!pendingStandPosition || !standFormData.standNumber) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    try {
      const newStand = {
        standNumber: standFormData.standNumber,
        positionX: Math.round(pendingStandPosition.lng),
        positionY: Math.round(pendingStandPosition.lat),
        width: standFormData.width,
        height: standFormData.height,
        type: standFormData.type,
        status: 'AVAILABLE'
      };

      if (onCreateStand) {
        await onCreateStand(newStand);
      }
      
      setTempStands([...tempStands, { ...newStand, id: Date.now() }]);
      
      setShowStandForm(false);
      setPendingStandPosition(null);
      setStandFormData({
        standNumber: '',
        type: 'WALL',
        width: 100,
        height: 100
      });
      
      clearTempMarkers();
      
      alert('‚úÖ –°—Ç–µ–Ω–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
      
    } catch (err) {
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
    }
  };

  const getTypeText = (type) => {
    const types = {
      'WALL': 'üé® –°—Ç–µ–Ω–∞ –¥–ª—è –∂–∏–≤–æ–ø–∏—Å–∏',
      'BOOTH': 'üóø –ë—É–¥–∫–∞ –¥–ª—è —Å–∫—É–ª—å–ø—Ç—É—Ä',
      'OPEN_SPACE': 'üì∑ –û—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ'
    };
    return types[type] || type;
  };

  const getStats = () => {
    const allStands = [...(stands || []), ...tempStands];
    return {
      total: allStands.length,
      available: allStands.filter(s => s.status === 'AVAILABLE').length,
      booked: allStands.filter(s => s.status === 'BOOKED').length,
      maintenance: allStands.filter(s => s.status === 'MAINTENANCE').length
    };
  };

  const stats = getStats();

  const handleSaveAll = async () => {
    try {
      // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
      if (tempStands.length > 0) {
        alert(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${tempStands.length} —Å—Ç–µ–Ω–¥–æ–≤!`);
      } else {
        alert('‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
      }
    } catch (error) {
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
  };

  const handleBack = () => {
    if (window.confirm('–í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç?')) {
      navigate('/gallery/dashboard');
    }
  };

  // ========== RENDER ==========
  return (
    <div style={{
      display: 'flex',
      height: 'calc(100vh - 80px)',
      backgroundColor: '#f8f9fa',
      padding: '20px',
      paddingBottom: '80px'
    }}>
      {/* –®–ê–ü–ö–ê –° –ö–ù–û–ü–ö–ê–ú–ò */}
      <div style={{
        position: 'absolute',
        top: '20px',
        left: '20px',
        right: '20px',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center',
        zIndex: 1000
      }}>
        <button
          onClick={handleBack}
          style={{
            padding: '10px 20px',
            backgroundColor: '#6c757d',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '8px',
            fontWeight: '500',
            boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
            transition: 'all 0.2s'
          }}
          onMouseOver={(e) => e.target.style.backgroundColor = '#5a6268'}
          onMouseOut={(e) => e.target.style.backgroundColor = '#6c757d'}
        >
          ‚Üê –ù–∞–∑–∞–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
        </button>
        
        {mode === 'owner' && (
          <button
            onClick={handleSaveAll}
            style={{
              padding: '10px 20px',
              backgroundColor: '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              fontWeight: '500',
              boxShadow: '0 2px 5px rgba(0,0,0,0.1)',
              transition: 'all 0.2s'
            }}
            onMouseOver={(e) => e.target.style.backgroundColor = '#218838'}
            onMouseOut={(e) => e.target.style.backgroundColor = '#28a745'}
          >
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          </button>
        )}
      </div>

      {/* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ - –£–ü–†–ê–í–õ–ï–ù–ò–ï */}
      <div style={{
        width: '320px',
        backgroundColor: 'white',
        padding: '20px',
        borderRadius: '12px',
        marginRight: '20px',
        marginTop: '60px',
        boxShadow: '0 4px 12px rgba(0,0,0,0.08)',
        overflowY: 'auto',
        border: '1px solid #dee2e6'
      }}>
        <h2 style={{ 
          marginTop: 0, 
          marginBottom: '20px', 
          color: '#343a40',
          borderBottom: '2px solid #007bff',
          paddingBottom: '10px',
          fontSize: '24px'
        }}>
          {mode === 'owner' ? 'üé® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç–∞–≤–∫–æ–π' : 'üìÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ'}
        </h2>
        
        {mode === 'owner' ? (
          <>
            {/* –°–ï–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –ö–ê–†–¢–´ –ù–ê –°–ï–†–í–ï–† */}
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: '20px', 
              borderRadius: '10px',
              marginBottom: '20px',
              border: '2px dashed #dee2e6'
            }}>
              <h4 style={{ marginTop: 0, color: '#495057', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ 
                  width: '30px', 
                  height: '30px', 
                  background: '#007bff', 
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'white',
                  fontSize: '16px'
                }}>1</span>
                –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω–∞ –∑–∞–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
              </h4>
              
              <div style={{ marginBottom: '15px' }}>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  id="mapUpload"
                  style={{ display: 'none' }}
                  disabled={loading}
                />
                <label htmlFor="mapUpload" style={{
                  display: 'block',
                  padding: '15px',
                  background: loading ? '#e9ecef' : 'linear-gradient(135deg, #007bff, #0056b3)',
                  color: loading ? '#6c757d' : 'white',
                  textAlign: 'center',
                  borderRadius: '8px',
                  cursor: loading ? 'not-allowed' : 'pointer',
                  fontWeight: '600',
                  fontSize: '16px',
                  transition: 'all 0.2s',
                  opacity: loading ? 0.7 : 1
                }}>
                  {loading ? '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...' : 'üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–ª–∞–Ω –∑–∞–ª–∞'}
                </label>
                
                {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */}
                {loading && uploadProgress > 0 && (
                  <div style={{
                    marginTop: '15px',
                    background: '#e9ecef',
                    borderRadius: '6px',
                    overflow: 'hidden'
                  }}>
                    <div style={{
                      width: `${uploadProgress}%`,
                      height: '6px',
                      background: 'linear-gradient(90deg, #28a745, #20c997)',
                      transition: 'width 0.3s'
                    }}></div>
                    <div style={{
                      padding: '8px 12px',
                      fontSize: '12px',
                      color: '#495057',
                      textAlign: 'center'
                    }}>
                      –ó–∞–≥—Ä—É–∑–∫–∞: {uploadProgress}%
                    </div>
                  </div>
                )}
                
                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ */}
                {uploadedImageUrl && !loading && (
                  <div style={{
                    backgroundColor: '#d4edda',
                    color: '#155724',
                    padding: '12px',
                    borderRadius: '6px',
                    marginTop: '15px',
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <span style={{ fontSize: '18px' }}>‚úÖ</span>
                    <div>
                      <div><strong>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä</strong></div>
                      <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>
                        ID –∫–∞—Ä—Ç—ã: {hallMapId || '–Ω–æ–≤—ã–π'}
                      </div>
                    </div>
                  </div>
                )}
                
                {mapImage && !imageError && !loading && (
                  <div style={{
                    backgroundColor: '#cce5ff',
                    color: '#004085',
                    padding: '12px',
                    borderRadius: '6px',
                    marginTop: '15px',
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <span style={{ fontSize: '18px' }}>üó∫Ô∏è</span>
                    <span>–ö–∞—Ä—Ç–∞ –∑–∞–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>
                  </div>
                )}
                
                {imageError && (
                  <div style={{
                    backgroundColor: '#f8d7da',
                    color: '#721c24',
                    padding: '12px',
                    borderRadius: '6px',
                    marginTop: '15px',
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <span style={{ fontSize: '18px' }}>‚ùå</span>
                    <span>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
                  </div>
                )}
              </div>
              
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ä—Ç–µ */}
              {hallMapId && (
                <div style={{
                  backgroundColor: '#fff3cd',
                  color: '#856404',
                  padding: '12px',
                  borderRadius: '6px',
                  marginTop: '10px',
                  fontSize: '13px',
                  border: '1px solid #ffeaa7'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '5px' }}>
                    <span style={{ fontSize: '16px' }}>‚ÑπÔ∏è</span>
                    <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</strong>
                  </div>
                  <div style={{ fontSize: '12px', opacity: 0.9 }}>
                    ID –∫–∞—Ä—Ç—ã: <code>{hallMapId}</code><br />
                    {hallMap?.name && `–ù–∞–∑–≤–∞–Ω–∏–µ: ${hallMap.name}`}
                  </div>
                </div>
              )}
            </div>
             {/* –°–ï–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–¢–ï–ù–î–û–í */}
             <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: '20px', 
              borderRadius: '10px',
              marginBottom: '20px',
              border: isDrawing ? '2px solid #28a745' : '2px solid #dee2e6'
            }}>
              <h4 style={{ marginTop: 0, color: '#495057', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ 
                  width: '30px', 
                  height: '30px', 
                  background: '#28a745', 
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'white',
                  fontSize: '16px'
                }}>2</span>
                –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–µ–Ω–¥–æ–≤
              </h4>
              
              <div style={{ marginBottom: '15px' }}>
                <button
                  onClick={handleToggleDrawing}
                  style={{
                    width: '100%',
                    padding: '15px',
                    background: isDrawing 
                      ? 'linear-gradient(135deg, #dc3545, #c82333)' 
                      : 'linear-gradient(135deg, #28a745, #218838)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: '600',
                    fontSize: '16px',
                    transition: 'all 0.2s'
                  }}
                >
                  {isDrawing ? '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ' : '‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–µ–Ω–¥'}
                </button>
                
                <div style={{ 
                  backgroundColor: isDrawing ? '#d4edda' : '#fff3cd',
                  color: isDrawing ? '#155724' : '#856404',
                  padding: '15px',
                  borderRadius: '8px',
                  marginTop: '15px',
                  fontSize: '14px',
                  border: `2px solid ${isDrawing ? '#c3e6cb' : '#ffeaa7'}`
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' }}>
                    <span style={{ fontSize: '20px' }}></span>
                    <strong>{isDrawing ? '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω' : '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è'}</strong>
                  </div>
                  <p style={{ margin: 0 }}>
                    {isDrawing 
                      ? '–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ —Å–ø—Ä–∞–≤–∞ –≤ –Ω—É–∂–Ω–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Ç–µ–Ω–¥'
                      : '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–µ–Ω–¥–æ–≤'}
                  </p>
                </div>

                {/* –í–ò–ó–£–ê–õ–¨–ù–´–ô –ò–ù–î–ò–ö–ê–¢–û–† –†–ï–ñ–ò–ú–ê */}
                {isDrawing && (
                  <div style={{
                    backgroundColor: '#d1ecf1',
                    border: '2px solid #bee5eb',
                    color: '#0c5460',
                    padding: '12px',
                    borderRadius: '8px',
                    marginTop: '15px',
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <div style={{
                      width: '20px',
                      height: '20px',
                      background: '#17a2b8',
                      borderRadius: '50%',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      fontSize: '12px'
                    }}>üéØ</div>
                    <div>
                      <strong>–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–µ–Ω</strong>
                      <div style={{ fontSize: '12px', marginTop: '4px', opacity: 0.8 }}>
                        –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Ç–µ–Ω–¥
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {/* –§–û–†–ú–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –°–¢–ï–ù–î–ê */}
              {showStandForm && (
                <div style={{
                  backgroundColor: 'white',
                  padding: '20px',
                  borderRadius: '10px',
                  border: '2px solid #007bff',
                  marginTop: '15px',
                  boxShadow: '0 4px 15px rgba(0,123,255,0.15)'
                }}>
                  <h5 style={{ marginTop: 0, color: '#007bff', fontSize: '18px' }}>
                    üìù –ù–æ–≤—ã–π —Å—Ç–µ–Ω–¥
                  </h5>
                  
                  <div style={{ marginBottom: '15px' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#495057' }}>
                      –ù–æ–º–µ—Ä —Å—Ç–µ–Ω–¥–∞ *
                    </label>
                    <input
                      type="text"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: A1, B2"
                      value={standFormData.standNumber}
                      onChange={(e) => setStandFormData({...standFormData, standNumber: e.target.value})}
                      style={{
                        width: '100%',
                        padding: '12px',
                        border: '2px solid #ced4da',
                        borderRadius: '6px',
                        fontSize: '16px',
                        transition: 'border-color 0.2s'
                      }}
                      onFocus={(e) => e.target.style.borderColor = '#007bff'}
                      onBlur={(e) => e.target.style.borderColor = '#ced4da'}
                    />
                  </div>
                  
                  <div style={{ marginBottom: '15px' }}>
                    <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#495057' }}>
                      –¢–∏–ø —Å—Ç–µ–Ω–¥–∞
                    </label>
                    // –ò–∑–º–µ–Ω–∏—Ç–µ options –≤ —Ñ–æ—Ä–º–µ:
<select
  value={standFormData.type}
  onChange={(e) => setStandFormData({...standFormData, type: e.target.value})}
>
  <option value="WALL">üé® –°—Ç–µ–Ω–∞ –¥–ª—è –∂–∏–≤–æ–ø–∏—Å–∏</option>
  <option value="BOOTH">üóø –ë—É–¥–∫–∞ –¥–ª—è —Å–∫—É–ª—å–ø—Ç—É—Ä</option>
  <option value="OPEN_SPACE">üì∑ –û—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</option>
</select>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '15px', marginBottom: '20px' }}>
                    <div style={{ flex: 1 }}>
                      <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#495057' }}>
                        –®–∏—Ä–∏–Ω–∞ (—Å–º)
                      </label>
                      <input
                        type="number"
                        min="50"
                        max="500"
                        value={standFormData.width}
                        onChange={(e) => setStandFormData({...standFormData, width: parseInt(e.target.value) || 100})}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #ced4da',
                          borderRadius: '6px',
                          fontSize: '16px',
                          transition: 'border-color 0.2s'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#007bff'}
                        onBlur={(e) => e.target.style.borderColor = '#ced4da'}
                      />
                    </div>
                    <div style={{ flex: 1 }}>
                      <label style={{ display: 'block', marginBottom: '8px', fontSize: '14px', fontWeight: '500', color: '#495057' }}>
                        –í—ã—Å–æ—Ç–∞ (—Å–º)
                      </label>
                      <input
                        type="number"
                        min="50"
                        max="500"
                        value={standFormData.height}
                        onChange={(e) => setStandFormData({...standFormData, height: parseInt(e.target.value) || 100})}
                        style={{
                          width: '100%',
                          padding: '12px',
                          border: '2px solid #ced4da',
                          borderRadius: '6px',
                          fontSize: '16px',
                          transition: 'border-color 0.2s'
                        }}
                        onFocus={(e) => e.target.style.borderColor = '#007bff'}
                        onBlur={(e) => e.target.style.borderColor = '#ced4da'}
                      />
                    </div>
                  </div>
                  
                  <div style={{ display: 'flex', gap: '15px' }}>
                    <button
                      onClick={handleSaveStand}
                      style={{
                        flex: 1,
                        padding: '12px',
                        background: 'linear-gradient(135deg, #28a745, #218838)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '16px',
                        transition: 'all 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–µ–Ω–¥
                    </button>
                    <button
                      onClick={() => {
                        setShowStandForm(false);
                        setPendingStandPosition(null);
                        clearTempMarkers();
                      }}
                      style={{
                        flex: 1,
                        padding: '12px',
                        background: 'linear-gradient(135deg, #6c757d, #5a6268)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '6px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '16px',
                        transition: 'all 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      ‚ùå –û—Ç–º–µ–Ω–∞
                    </button>
                  </div>
                </div>
              )}
            </div>
            
            {/* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */}
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: '20px', 
              borderRadius: '10px',
              marginBottom: '20px',
              border: '2px solid #dee2e6'
            }}>
              <h4 style={{ marginTop: 0, color: '#495057', display: 'flex', alignItems: 'center', gap: '10px' }}>
                <span style={{ 
                  width: '30px', 
                  height: '30px', 
                  background: '#6f42c1', 
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'white',
                  fontSize: '16px'
                }}>3</span>
                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ã—Å—Ç–∞–≤–∫–∏
              </h4>
              
              <div style={{ 
                display: 'grid', 
                gridTemplateColumns: '1fr 1fr', 
                gap: '15px',
                marginBottom: '20px'
              }}>
                <div style={{ 
                  background: 'linear-gradient(135deg, #343a40, #212529)', 
                  padding: '15px', 
                  borderRadius: '8px',
                  textAlign: 'center',
                  color: 'white'
                }}>
                  <div style={{ fontSize: '28px', fontWeight: 'bold' }}>
                    {stats.total}
                  </div>
                  <div style={{ fontSize: '12px', opacity: 0.9 }}>
                    –í—Å–µ–≥–æ —Å—Ç–µ–Ω–¥–æ–≤
                  </div>
                </div>
                <div style={{ 
                  background: 'linear-gradient(135deg, #28a745, #218838)', 
                  padding: '15px', 
                  borderRadius: '8px',
                  textAlign: 'center',
                  color: 'white'
                }}>
                  <div style={{ fontSize: '28px', fontWeight: 'bold' }}>
                    {stats.available}
                  </div>
                  <div style={{ fontSize: '12px', opacity: 0.9 }}>
                    –°–≤–æ–±–æ–¥–Ω–æ
                  </div>
                </div>
                <div style={{ 
                  background: 'linear-gradient(135deg, #dc3545, #c82333)', 
                  padding: '15px', 
                  borderRadius: '8px',
                  textAlign: 'center',
                  color: 'white'
                }}>
                  <div style={{ fontSize: '28px', fontWeight: 'bold' }}>
                    {stats.booked}
                  </div>
                  <div style={{ fontSize: '12px', opacity: 0.9 }}>
                    –ó–∞–Ω—è—Ç–æ
                  </div>
                </div>
                <div style={{ 
                  background: 'linear-gradient(135deg, #ffc107, #e0a800)', 
                  padding: '15px', 
                  borderRadius: '8px',
                  textAlign: 'center',
                  color: '#212529'
                }}>
                  <div style={{ fontSize: '28px', fontWeight: 'bold' }}>
                    {stats.maintenance}
                  </div>
                  <div style={{ fontSize: '12px', opacity: 0.9 }}>
                    –í —Ä–µ–º–æ–Ω—Ç–µ
                  </div>
                </div>
              </div>
            </div>
          </>
        ) : (
          /* –ò–ù–¢–ï–†–§–ï–ô–° –•–£–î–û–ñ–ù–ò–ö–ê */
          <>
            <div style={{ 
              backgroundColor: '#f8f9fa', 
              padding: '20px', 
              borderRadius: '10px',
              marginBottom: '20px',
              border: '2px solid #dee2e6'
            }}>
              <h4 style={{ marginTop: 0, color: '#495057' }}>
                üé® –í—ã–±–æ—Ä —Å—Ç–µ–Ω–¥–∞
              </h4>
              
              {selectedStand ? (
                <>
                  <div style={{ 
                    background: 'linear-gradient(135deg, #007bff, #0056b3)', 
                    padding: '20px', 
                    borderRadius: '10px',
                    marginBottom: '20px',
                    color: 'white'
                  }}>
                    <h5 style={{ marginTop: 0, fontSize: '20px' }}>
                      –°—Ç–µ–Ω–¥ {selectedStand.standNumber}
                    </h5>
                    <p style={{ margin: '10px 0', opacity: 0.9 }}>
                      <strong>–¢–∏–ø:</strong> {getTypeText(selectedStand.type)}
                    </p>
                    <p style={{ margin: '10px 0', opacity: 0.9 }}>
                      <strong>–†–∞–∑–º–µ—Ä:</strong> {selectedStand.width}√ó{selectedStand.height} —Å–º
                    </p>
                    <p style={{ margin: '10px 0' }}>
                      <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                      <span style={{ 
                        color: selectedStand.status === 'BOOKED' ? '#ffcccb' : '#90ee90',
                        fontWeight: 'bold',
                        marginLeft: '5px'
                      }}>
                        {selectedStand.status === 'BOOKED' ? '–ó–∞–Ω—è—Ç' : '–°–≤–æ–±–æ–¥–µ–Ω'}
                      </span>
                    </p>
                  </div>
                  
                  {selectedStand.status !== 'BOOKED' ? (
                    <button
                      onClick={handleBookStand}
                      style={{
                        width: '100%',
                        padding: '15px',
                        background: 'linear-gradient(135deg, #28a745, #218838)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        fontWeight: '600',
                        fontSize: '18px',
                        transition: 'all 0.2s'
                      }}
                      onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                      onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
                    >
                      üìù –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å—Ç–µ–Ω–¥
                    </button>
                  ) : (
                    <div style={{
                      background: 'linear-gradient(135deg, #dc3545, #c82333)',
                      color: 'white',
                      padding: '15px',
                      borderRadius: '8px',
                      textAlign: 'center',
                      marginBottom: '15px'
                    }}>
                      <div style={{ fontSize: '24px', marginBottom: '10px' }}>‚ö†Ô∏è</div>
                      <div style={{ fontWeight: '600' }}>–≠—Ç–æ—Ç —Å—Ç–µ–Ω–¥ —É–∂–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω</div>
                    </div>
                  )}
                </>
              ) : (
                <div style={{ 
                  background: 'linear-gradient(135deg, #6c757d, #5a6268)', 
                  padding: '30px 20px', 
                  borderRadius: '10px',
                  textAlign: 'center',
                  color: 'white'
                }}>
                  <div style={{ fontSize: '48px', marginBottom: '15px' }}>üéØ</div>
                  <h5 style={{ margin: '10px 0', fontSize: '20px' }}>
                    –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–µ–Ω–¥ –Ω–∞ –∫–∞—Ä—Ç–µ
                  </h5>
                  <p style={{ fontSize: '14px', opacity: 0.8, margin: 0 }}>
                    –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π —Å–≤–æ–±–æ–¥–Ω—ã–π —Å—Ç–µ–Ω–¥ (–∑–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞)
                  </p>
                </div>
              )}
            </div>
          </>
        )}
      </div>
      
      {/* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ - –ö–ê–†–¢–ê */}
      <div style={{
        flex: 1,
        position: 'relative',
        backgroundColor: '#ffffff',
        borderRadius: '12px',
        marginTop: '60px',
        overflow: 'hidden',
        boxShadow: '0 8px 30px rgba(0,0,0,0.12)',
        border: '15px solid #ffffff',
        display: 'flex',
        flexDirection: 'column'
      }}>
        {/* –ó–ê–ì–û–õ–û–í–û–ö –ö–ê–†–¢–´ */}
        <div style={{
          padding: '15px 20px',
          backgroundColor: '#f8f9fa',
          borderBottom: '2px solid #dee2e6',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <div>
            <h3 style={{ margin: 0, color: '#343a40', display: 'flex', alignItems: 'center', gap: '10px' }}>
              <span style={{ color: '#007bff' }}>üó∫Ô∏è</span>
              –ö–∞—Ä—Ç–∞ –≤—ã—Å—Ç–∞–≤–∫–∏
            </h3>
            <p style={{ margin: '5px 0 0 0', color: '#6c757d', fontSize: '14px' }}>
              {mapImage ? '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è' : '–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–ª–∞–Ω –∑–∞–ª–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã'}
            </p>
          </div>
          
          <div style={{
            backgroundColor: mode === 'owner' ? '#007bff' : '#28a745',
            color: 'white',
            padding: '8px 16px',
            borderRadius: '20px',
            fontSize: '14px',
            fontWeight: '600',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}>
            {mode === 'owner' ? 'üëë –í–ª–∞–¥–µ–ª–µ—Ü' : 'üé® –•—É–¥–æ–∂–Ω–∏–∫'}
          </div>
        </div>
        
        {/* –û–ë–õ–ê–°–¢–¨ –ö–ê–†–¢–´ */}
        <div 
          ref={mapRef} 
          style={{
            flex: 1,
            width: '100%',
            backgroundColor: '#f8f9fa'
          }}
        />
        
        {/* –ü–ê–ù–ï–õ–¨ –ò–ù–§–û–†–ú–ê–¶–ò–ò */}
        <div style={{
          padding: '15px 20px',
          backgroundColor: '#f8f9fa',
          borderTop: '2px solid #dee2e6',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          fontSize: '14px',
          color: '#495057'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <div style={{ width: '12px', height: '12px', backgroundColor: '#28a745', borderRadius: '50%' }}></div>
              <span>–°–≤–æ–±–æ–¥–Ω–æ ({stats.available})</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <div style={{ width: '12px', height: '12px', backgroundColor: '#dc3545', borderRadius: '50%' }}></div>
              <span>–ó–∞–Ω—è—Ç–æ ({stats.booked})</span>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <div style={{ width: '12px', height: '12px', backgroundColor: '#ffc107', borderRadius: '50%' }}></div>
              <span>–†–µ–º–æ–Ω—Ç ({stats.maintenance})</span>
            </div>
          </div>
          
          <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span style={{ opacity: 0.7 }}>–ú–∞—Å—à—Ç–∞–±:</span>
              <span style={{ fontWeight: '600' }}>{mapScale.toFixed(1)}x</span>
            </div>
            <div style={{ 
              padding: '6px 12px', 
              backgroundColor: 'white', 
              borderRadius: '6px',
              border: '1px solid #dee2e6',
              display: 'flex',
              alignItems: 'center',
              gap: '8px'
            }}>
              <span>üîç</span>
              <span>–ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MapEditor;

  // const loadHallMapImage = (imageUrl) => {
  //   if (!mapInstance.current || !imageUrl) return;

  //   const img = new Image();
  //   img.crossOrigin = 'anonymous';

  //   img.onload = function() {
  //     const width = this.width;
  //     const height = this.height;
  //     const bounds = [[0, 0], [height, width]];

  //     mapInstance.current.eachLayer((layer) => {
  //       if (!(layer instanceof L.Control)) {
  //         mapInstance.current.removeLayer(layer);
  //       }
  //     });

  //     imageOverlayRef.current = L.imageOverlay(imageUrl, bounds, {
  //       interactive: false,
  //       className: 'hall-map-image'
  //     }).addTo(mapInstance.current);

  //     mapInstance.current.fitBounds(bounds);
  //     const centerY = height / 2;
  //     const centerX = width / 2;
  //     mapInstance.current.setView([centerY, centerX], 0);

  //     setImageError(false);
  //     setMapImage(imageUrl);

  //     setTimeout(() => {
  //       renderStands();
  //     }, 100);
  //   };

  //   img.onerror = function() {
  //     console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  //     setImageError(true);
  //     showPlaceholder();
  //   };

  //   img.src = imageUrl;
  // };

  // const loadImageToMap = (imageUrl) => {
  //   return new Promise((resolve, reject) => {
  //     if (!mapInstance.current || !imageUrl) {
  //       reject('–ù–µ—Ç –∫–∞—Ä—Ç—ã –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  //       return;
  //     }

  //     const img = new Image();
  //     img.crossOrigin = 'anonymous';

  //     img.onload = function() {
  //       const width = this.width;
  //       const height = this.height;
  //       const bounds = [[0, 0], [height, width]];

  //       if (imageOverlayRef.current) {
  //         mapInstance.current.removeLayer(imageOverlayRef.current);
  //         imageOverlayRef.current = null;
  //       }

  //       imageOverlayRef.current = L.imageOverlay(imageUrl, bounds, {
  //         interactive: false,
  //         className: 'hall-map-image'
  //       }).addTo(mapInstance.current);

  //       mapInstance.current.fitBounds(bounds);
  //       const centerY = height / 2;
  //       const centerX = width / 2;
  //       mapInstance.current.setView([centerY, centerX], 0);

  //       setImageError(false);
  //       setMapImage(imageUrl);
  //       resolve();
  //     };

  //     img.onerror = function() {
  //       console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  //       setImageError(true);
  //       reject('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
  //     };

  //     img.src = imageUrl;
  //   });
  // };

    // const handleApproveBooking = async (standId) => {
  //   try {
  //     console.log('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç–µ–Ω–¥–∞:', standId);
      
  //     // 1. –ü–æ–ª—É—á–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  //     const response = await ownerApi.getPendingBookings();
  //     console.log('–û—Ç–≤–µ—Ç –æ—Ç getPendingBookings:', response);
      
  //     // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ bookings –∏–∑ –æ—Ç–≤–µ—Ç–∞
  //     // –û—Ç–≤–µ—Ç –∏–º–µ–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: { "bookings": [...] }
  //     const bookingsArray = response.bookings || response.data?.bookings || response;
      
  //     console.log('–ú–∞—Å—Å–∏–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π:', bookingsArray);
  //     console.log('–≠—Ç–æ –º–∞—Å—Å–∏–≤?', Array.isArray(bookingsArray));
      
  //     // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
  //     if (!Array.isArray(bookingsArray)) {
  //       console.error('bookingsArray –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º:', bookingsArray);
  //       alert('–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö');
  //       return;
  //     }
      
  //     // 4. –ò—â–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–µ–Ω–¥–∞
  //     const booking = bookingsArray.find(b => {
  //       // –ò—Å–ø–æ–ª—å–∑—É–µ–º exhibitionStandId –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞
  //       const bookingStandId = b.exhibitionStandId || b.exhibitionStand?.id || b.stand?.id;
  //       console.log(`–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: bookingStandId=${bookingStandId}, standId=${standId}`);
  //       return bookingStandId === standId;
  //     });
      
  //     console.log('–ù–∞–π–¥–µ–Ω–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', booking);
      
  //     if (!booking) {
  //       alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–µ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  //       return;
  //     }
      
  //     // 5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  //     const approveResponse = await ownerApi.approveBooking(booking.id);
  //     console.log('–û—Ç–≤–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', approveResponse);
      
  //     // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–Ω–¥—ã
  //     await refreshStands();
      
  //     alert('‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!');
      
  //   } catch (error) {
  //     console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
  //     alert(`‚ùå –û—à–∏–±–∫–∞: ${error.response?.data?.error || error.message}`);
  //   }
  // };
  
  // const handleRejectBooking = async (standId) => {
  //   try {
  //     console.log('–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å—Ç–µ–Ω–¥–∞:', standId);
      
  //     // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
  //     const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:');
  //     if (!reason || reason.trim() === '') {
  //       alert('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
  //       return;
  //     }
      
  //     // 1. –ü–æ–ª—É—á–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  //     const response = await ownerApi.getPendingBookings();
      
  //     // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –º–∞—Å—Å–∏–≤ bookings –∏–∑ –æ—Ç–≤–µ—Ç–∞
  //     const bookingsArray = response.bookings || response.data?.bookings || response;
      
  //     if (!Array.isArray(bookingsArray)) {
  //       alert('–û—à–∏–±–∫–∞: –ø–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö');
  //       return;
  //     }
      
  //     // 3. –ò—â–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  //     const booking = bookingsArray.find(b => {
  //       const bookingStandId = b.exhibitionStandId || b.exhibitionStand?.id || b.stand?.id;
  //       return bookingStandId === standId;
  //     });
      
  //     if (!booking) {
  //       alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–µ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  //       return;
  //     }
      
  //     // 4. –û—Ç–∫–ª–æ–Ω—è–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  //     const rejectResponse = await ownerApi.rejectBooking(booking.id, reason);
  //     console.log('–û—Ç–≤–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', rejectResponse);
      
  //     // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–µ–Ω–¥—ã
  //     await refreshStands();
      
  //     alert('‚ùå –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ!');
      
  //   } catch (error) {
  //     console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:', error);
  //     alert(`‚ùå –û—à–∏–±–∫–∞: ${error.response?.data?.error || error.message}`);
  //   }
  // };